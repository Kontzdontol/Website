document.addEventListener("DOMContentLoaded", () => {
  // ===== POPUP LOGIC =====
  const popups = document.querySelectorAll(".popup");
  const triggers = [
    { icon: "profileIcon", popup: "profilePopup" },
    { icon: "emailIcon", popup: "emailPopup" },
    { icon: "instaIcon", popup: "instaPopup" },
    { icon: "twitterIcon", popup: "twitterPopup" },
    { icon: "mediumIcon", popup: "mediumPopup" },
  ];

  triggers.forEach(({ icon, popup }) => {
    document.getElementById(icon)?.addEventListener("click", () => {
      closeAllPopups();
      document.getElementById(popup).style.display = "block";
    });
  });

  document.querySelectorAll(".close-popup").forEach((btn) =>
    btn.addEventListener("click", (e) => {
      const target = e.target.getAttribute("data-target");
      document.getElementById(target).style.display = "none";
    })
  );

  function closeAllPopups() {
    popups.forEach((popup) => (popup.style.display = "none"));
  }

  // ===== IMAGE EDITOR MODAL =====
  const imageModal = document.getElementById("imageModal");
  const openImageModal = document.getElementById("openImageModal");
  const closeImageModal = document.getElementById("closeImageModal");

  openImageModal?.addEventListener("click", () => {
    imageModal.style.display = "block";
  });

  closeImageModal?.addEventListener("click", () => {
    imageModal.style.display = "none";
  });

  const imageInput = document.getElementById("imageInput");
  const promptContainer = document.getElementById("promptContainer");
  const generateImageBtn = document.getElementById("generateImageBtn");
  const statusImage = document.getElementById("statusImage");
  const uploadedMemeImage = document.getElementById("uploadedMemeImage");

  imageInput?.addEventListener("change", () => {
    if (imageInput.files.length > 0) {
      promptContainer.style.display = "block";
    }
  });

  generateImageBtn?.addEventListener("click", async () => {
    const prompt = document.getElementById("imagePrompt")?.value;
    const file = imageInput.files[0];
    if (!file || !prompt) {
      alert("Lengkapi gambar dan prompt terlebih dahulu.");
      return;
    }

    const formData = new FormData();
    formData.append("image", file);
    formData.append("prompt", prompt);

    statusImage.textContent = "⏳ Mengunggah dan memproses gambar...";
    uploadedMemeImage.style.display = "none";

    try {
      const res = await fetch("/api/flux-kontext-pro", {
        method: "POST",
        body: formData,
      });

      const data = await res.json();
      if (res.ok && data?.image_url) {
        uploadedMemeImage.src = data.image_url;
        uploadedMemeImage.style.display = "block";
        statusImage.textContent = "✅ Gambar berhasil dibuat!";
      } else {
        throw new Error(data?.message || "Gagal menghasilkan gambar.");
      }
    } catch (err) {
      statusImage.textContent = "❌ Terjadi kesalahan: " + err.message;
    }
  });

  // ===== ART GENERATOR MODAL =====
  const artModal = document.getElementById("artModal");
  const openArtModalBtn = document.getElementById("openArtModalBtn");
  const closeArtModal = document.getElementById("closeArtModal");
  const generateArtBtn = document.getElementById("generateArtBtn");
  const artPromptInput = document.getElementById("artPrompt");
  const statusArt = document.getElementById("statusArt");
  const uploadedArtImage = document.getElementById("uploadedArtImage");

  openArtModalBtn?.addEventListener("click", () => {
    artModal.style.display = "block";
  });

  closeArtModal?.addEventListener("click", () => {
    artModal.style.display = "none";
  });

  generateArtBtn?.addEventListener("click", async () => {
    const prompt = artPromptInput.value.trim();
    if (!prompt) {
      alert("Prompt tidak boleh kosong.");
      return;
    }

    statusArt.textContent = "🎨 Menghasilkan gambar...";
    uploadedArtImage.style.display = "none";

    try {
      const response = await fetch("/api/generate-art", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ prompt }),
      });

      const data = await response.json();
      if (response.ok && data?.image_url) {
        uploadedArtImage.src = data.image_url;
        uploadedArtImage.style.display = "block";
        statusArt.textContent = "✅ Art berhasil dibuat!";
      } else {
        throw new Error(data?.message || "Gagal membuat art.");
      }
    } catch (err) {
      statusArt.textContent = "❌ Error: " + err.message;
    }
  });

  // ===== CLOSE MODALS OUTSIDE CLICK =====
  window.addEventListener("click", (event) => {
    if (event.target === imageModal) imageModal.style.display = "none";
    if (event.target === artModal) artModal.style.display = "none";
  });
});
